

<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width"
    />
    <title>A-Frame Porsche Rotate</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.x.x/dist/aframe-event-set-component.min.js"></script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <a-asset-item id="gtr" src="gtr/scene.gltf"></a-asset-item>
        <a-asset-item id="whitePorsche" src="porsche/white/scene.gltf"></a-asset-item>
        <a-asset-item id="greenPorsche" src="porsche/green/scene.gltf"></a-asset-item>
    
        <img id="background" src="./background.jpg">
        <img id="poster" src="./poster.png">
        <img id="explore" src="./explore.png">
        <video
          id="gtrVideo"
          autoplay
          loop
          muted
          playsinline
          crossorigin="anonymous"
          preload="auto"
          src="./gtrVideo.mp4"
        ></video>
        <video
          id="porscheVideo"
          autoplay
          loop
          muted
          playsinline
          crossorigin="anonymous"
          preload="auto"
          src="./porscheVideo.mp4"
        ></video>
      </a-assets>

      <a-sky src="#background" rotation="0 -90 0" material="shader: flat;" raycaster="objects: .clickable"></a-sky>

      <a-image src="#poster" position="-30 0 -20" scale="30 20 20" rotation="0 60 0"></a-image>

      <!-- Loading Spinner -->
      <a-entity id="loadingSpinner" position="0 1.5 -3" visible="false">
        <a-ring color="yellow" radius-inner="0.1" radius-outer="0.15" rotation="0 0 90">
          <a-animation attribute="rotation" dur="2000" to="0 0 -360" easing="linear" repeat="indefinite"></a-animation>
        </a-ring>
        <a-text value="Loading Model..." position="0 -0.2 0" align="center" color="white" scale="0.5 0.5 0.5"></a-text>
      </a-entity>

      <!-- GTR -->
      <a-entity position="0 0 -5">
        <a-cylinder
          id="triggerCylinder"
          class="clickable"
          position="0 -2 -10"
          radius="4"
          height="0.5"
          color="#808080"
        >
        <a-image id="gtrLink" src="#explore" position="0 0 6" scale="2 1 1" rotation="0 0 0"></a-image>

          <a-text
            id="cylinderText1"
            cursor="rayOrigin: mouse"
            value="Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. 
                  Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                  Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. 
                  Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. 
                  Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                  Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. 
                  Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum"
            align="center"
            color="#FFFFFF"
            visible="true"
            position="-2 4 -1.5"
            geometry="primitive: plane; width: 6; height: 6"
            material="color: #808080"
          >
            <a-video
              src="#gtrVideo"
              width="4"
              height="6"
              position="5 0 0"
              material="shader: flat; side: double; transparent: true"
            ></a-video>
          </a-text>
        </a-cylinder>

        <!-- Rotating model -->
        <a-entity position="0 -1.5 -8">
          <a-entity
            cursor="rayOrigin: mouse"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear"
            gltf-model="#gtr"
            position="0 0 0"
            scale="130 130 130"
          ></a-entity>
        </a-entity>
      </a-entity>

      <!-- PORSCHE -->
      <a-entity position="5 0 -13">
        <a-cylinder
          id="triggerCylinder"
          class="clickable"
          position="8 -2 5"
          radius="4"
          height="0.5"
          color="#808080"
        >
        <a-image id="porscheLink" src="#explore" position="-5 -0.1 3" scale="2 1 1" rotation="0 -60 0"></a-image>

          <a-text
            id="cylinderText2"
            cursor="rayOrigin: mouse"
            value="Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. 
                  Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                  Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. 
                  Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. 
                  Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                  Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. 
                  Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum"
            align="center"
            color="#FFFFFF"
            visible="true"
            position="1.2 4 -3"
            geometry="primitive: plane; width: 6; height: 6"
            material="color: #808080"
            rotation="0 300 0"
          >
            <a-video
              src="#porscheVideo"
              width="4"
              height="6"
              position="5 0 0"
              material="shader: flat; side: double; transparent: true"
              rotation="0 180 0"
            ></a-video>
          </a-text>
        </a-cylinder>

        <!-- Rotating model -->
        <a-entity position="-4 0.5 16">
          <a-entity
            id="porscheModel"
            cursor="rayOrigin: mouse"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear"
            gltf-model="#whitePorsche"
            position="10 -2 -10"
            scale="1.5 1.5 1.5"
          ></a-entity>
        </a-entity>

        <!-- Green Button -->
        <a-cylinder
          id="greenButton"
          class="clickable"
          position="5.5 -2 9.5"
          radius="0.3"
          height="0.1"
          color="#2c5f34"
          rotation="90 120 0"
        ></a-cylinder>

        <!-- White Button -->
        <a-cylinder
          id="whiteButton"
          class="clickable"
          position="3 -2 5"
          radius="0.3"
          height="0.1"
          color="#FFFFFF"
          rotation="90 120 0"
        ></a-cylinder>
      </a-entity>

      <!-- Camera with cursor -->
      <a-camera>
        <a-cursor
        material="color: #FFFFFF; opacity: 0.5; transparent: true">
        </a-cursor>
      </a-camera>
    </a-scene>

    <script>
      // Global flag to prevent multiple model changes at once
      let isChangingModel = false;
      
      // link
      function setupImageLinks() {
        const links = [
          { id: 'gtrLink', url: 'https://www.nissan.ph/vehicles/new/GT-R.html' },
          { id: 'porscheLink', url: 'https://www.porsche.com/usa/models/911/911-gt3-rs/911-gt3-rs/' },
        ];

        links.forEach(link => {
          const element = document.querySelector(`#${link.id}`);
          if (element) {
            element.addEventListener('click', function () {
              window.location.href = link.url;
            });
          }
        });
      }

      // Function to change Porsche model with memory management
      function changePorscheModel(color) {
        if (isChangingModel) return;
        isChangingModel = true;
        
        const porscheModel = document.querySelector("#porscheModel");
        const spinner = document.querySelector("#loadingSpinner");
        
        // Show loading spinner
        spinner.setAttribute('visible', 'true');
        porscheModel.setAttribute('visible', 'false');
        
        // Remove previous model to free memory
        porscheModel.removeAttribute('gltf-model');
        
        // Wait for cleanup to complete
        setTimeout(() => {
          try {
            if (color === 'white') {
              porscheModel.setAttribute('gltf-model', '#whitePorsche');
              porscheModel.setAttribute('scale', '1.5 1.5 1.5');
            } else if (color === 'green') {
              porscheModel.setAttribute('gltf-model', '#greenPorsche');
              porscheModel.setAttribute('scale', '150 150 150');
            }
            
            // Handle successful load
            function onModelLoaded() {
              porscheModel.setAttribute('visible', 'true');
              spinner.setAttribute('visible', 'false');
              porscheModel.removeEventListener('model-loaded', onModelLoaded);
              isChangingModel = false;
            }
            
            // Handle errors
            function onModelError() {
              console.error('Failed to load model');
              spinner.setAttribute('visible', 'false');
              isChangingModel = false;
              porscheModel.removeEventListener('error', onModelError);
            }
            
            porscheModel.addEventListener('model-loaded', onModelLoaded);
            porscheModel.addEventListener('error', onModelError);
            
          } catch (error) {
            console.error('Error changing model:', error);
            spinner.setAttribute('visible', 'false');
            isChangingModel = false;
          }
        }, 50); // Small delay to ensure cleanup
      }

      window.addEventListener('DOMContentLoaded', function() {
        setupImageLinks();
        
        // Add debounced event listeners for color buttons
        document.querySelector("#greenButton").addEventListener('click', function() {
          changePorscheModel('green');
        });
        
        document.querySelector("#whiteButton").addEventListener('click', function() {
          changePorscheModel('white');
        });
        
        const gtrVideo = document.querySelector("#gtrVideo");
        const porscheVideo = document.querySelector("#porscheVideo");
    
        // Improved video handling
        function handleVideo(video) {
          if (video.readyState >= 3) { // HAVE_FUTURE_DATA
            video.play().catch((e) => {
              console.error("Auto-play failed:", e);
              // Fallback: Play on user interaction
              document.addEventListener(
                "click",
                function playVideo() {
                  video.play();
                  document.removeEventListener("click", playVideo);
                },
                { once: true }
              );
            });
          }
        }

        // Event listeners for videos
        [gtrVideo, porscheVideo].forEach(video => {
          video.addEventListener("loadedmetadata", () => handleVideo(video));
          video.addEventListener("canplay", () => handleVideo(video));
          video.addEventListener("error", function () {
            console.error("Video error:", video.error);
          });
        });

        // Fallback: Try to play after a short delay
        setTimeout(() => {
          handleVideo(gtrVideo);
          handleVideo(porscheVideo);
        }, 1000);

        // Click handler component
        AFRAME.registerComponent("click-handler", {
          init: function () {
            this.el.addEventListener("mouseenter", () => {
              console.log("Hover detected on:", this.el);
            });

            this.el.addEventListener("click", (evt) => {
              console.log("Click event detected on:", this.el);
              const url = this.el.getAttribute("data-url");
              if (url) {
                window.open(url, "_blank");
              }
            });
          },
        });
      });
    </script>
  </body>
</html>
